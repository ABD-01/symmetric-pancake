# Hardfault Diagnostics on ARM

Functionality Support:
- [X] Bare-Metal
- [ ] FreeRTOS

## Build & Run

```bash
make
make debug
make gdb
```
<img width="1902" height="921" alt="image" src="https://github.com/user-attachments/assets/df12ac5f-d59d-48a0-bbe7-a8244a4d8ef8" />


Sample Output:
```
[HardFault]

---Registers---
        r0: 0000006A        r1: 00000011        r2: 12345678
        r3: DEADBEEF        r4: 00000044        r5: 00000055
        r6: 00000066        r7: 20001EB8        r8: 00000088
        r9: 00000099       r10: 000000AA       r11: 000000BB
       r12: 000000CC        sp: 20001E98        lr: 080015A5
        pc: 080015CE      xPSR: 21000000
       psp: 00000000       msp: 20001D4C   primask: 00000001
   control: 00000000   basepri: 00000000 faultmask: 00000000

---Special Registers---
EXC_RETURN: FFFFFFF9
      ICSR: 00000803 (0000 0000 0000 0000 0000 1000 0000 0011)
      HFSR: 40000000 (0100 0000 0000 0000 0000 0000 0000 0000) // HFSR.FORCED: 1
      CFSR: 00008200 (0000 0000 0000 0000 1000 0010 0000 0000)
      BFAR: DEADBEEF

---Stack Dump---
0x20001E90: ???????? ???????? 0000006A 00000011
0x20001EA0: 12345678 DEADBEEF 000000CC 080015A5 
0x20001EB0: 080015CE 21000000 20001EF0 0000006A
0x20001EC0: 00000000 DEADBEEF 00000000 20001ED0 
0x20001ED0: 08004784 0000002A 22400000 0000006A 
0x20001EE0: 20001EE8 08001587 00000077 08000811
0x20001EF0: 20001F04 20001F04 00000000 08003473 

---System Reset---
```

## Files

- `drivers/`: [STMicroelectronics/stm32f1xx-hal-driver: Provides the STM32Cube MCU Component "hal_driver" of the STM32F1 series.](https://github.com/STMicroelectronics/stm32f1xx-hal-driver/tree/master)
- `device/`: [startup_stm32f100xb.s](https://github.com/STMicroelectronics/cmsis-device-f1/blob/master/Source/Templates/gcc/startup_stm32f100xb.s), [stm32f100xb.h](https://github.com/STMicroelectronics/cmsis-device-f1/blob/master/Include/stm32f100xb.h), [system_stm32f1xx.h](https://github.com/STMicroelectronics/cmsis-device-f1/blob/master/Include/system_stm32f1xx.h), [system_stm32f1xx.c](https://github.com/STMicroelectronics/cmsis-device-f1/blob/master/Source/Templates/system_stm32f1xx.c), syscalls (autogenerated), sysmem.c (autogenerated)
- `cmsis`: [STMicroelectronics/STM32CubeF1/Drivers/CMSIS/Core/Include](https://github.com/STMicroelectronics/STM32CubeF1/tree/master/Drivers/CMSIS/Core/Include)

## References

Important ones are marked **bold**.

### Reading
- **[Using Cortex-M3/M4/M7 Fault Exceptions - ARM KEIL](https://www.keil.com/appnotes/files/apnt209.pdf)**
- **[The Definitive Guide to ARM® Cortex®-M3 and Cortex®-M4 Processors, 3rd Edition](https://booksite.elsevier.com/9780124080829/)**
- [ARM System Developer's Guide: Designing and Optimizing System Software](https://www.amazon.co.uk/ARM-System-Developers-Guide-Architecture/dp/1558608745)
- [Making Embedded Systems, 2nd Edition](https://www.oreilly.com/library/view/making-embedded-systems/9781098151539/)

### Fault Handling
- **[How to debug a HardFault on an ARM Cortex-M MCU | Interrupt](https://interrupt.memfault.com/blog/cortex-m-hardfault-debug)**
- [Ending the Embedded Software Dark Ages: Let’s Start With Processor Fault Debugging! - Embedded Artistry](https://embeddedartistry.com/blog/2021/01/11/hard-fault-debugging/)
- [mbed-os/platform/source/TARGET_CORTEX_M/mbed_fault_handler.c at master · ARMmbed/mbed-os](https://github.com/ARMmbed/mbed-os/blob/master/platform/source/TARGET_CORTEX_M/mbed_fault_handler.c#L44-L81)
- [CrashCatcher/../CrashCatcher\_armv6m.S (Github)](https://github.com/adamgreen/CrashCatcher/blob/master/Core/src/CrashCatcher_armv6m.S)
- [Cortex-M3/M4 Hard Fault Handler](https://blog.frankvh.com/2011/12/07/cortex-m3-m4-hard-fault-handler/)
- [Developing a Generic Hard Fault handler for ARM Cortex-M3/Cortex-M4](https://feabhasblog.wpengine.com/2013/02/developing-a-generic-hard-fault-handler-for-arm-cortex-m3cortex-m4/)
- [PX4-Autopilot/../hardfault\_log.c (Github)](https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/hardfault_log/hardfault_log.c)


### ARM References
- **[Cortex-M3 Devices Generic User Guide](https://developer.arm.com/documentation/dui0552/a/introduction/about-the-cortex-m3-processor-and-core-peripherals/cortex-m3-core-peripherals?lang=en)**
- [ARM Cortex-M for Beginners](https://community.arm.com/cfs-file/__key/telligent-evolution-components-attachments/01-2142-00-00-00-00-52-96/White-Paper-_2D00_-Cortex_2D00_M-for-Beginners-_2D00_-2016-_2800_final-v3_2900_.pdf)
- [Introduction to ARM - Gananand Kini (Slides)](https://www.opensecuritytraining.info/IntroARM_files/Introduction%20to%20ARM%20Systems-11-17-2012.pdf)
- [Introduction to ARM - Gananand Kini (Lectures)](https://www.youtube.com/playlist?list=PLUFkSN0XLZ-n91t_AX5zO007Giz1INwPd)
- [AArch64 Procedure Call Standard (AAPCS64): ABI, Calling Conventions & Machine Registers](https://medium.com/@tunacici7/aarch64-procedure-call-standard-aapcs64-abi-calling-conventions-machine-registers-a2c762540278)
- https://stackoverflow.com/a/72448512

### STM32F1xxxx
- [Reference Manual (PDF)](https://www.st.com/resource/en/reference_manual/rm0041-stm32f100xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [STM32CubeF1 HAL Driver MCU Component (Github)](https://github.com/STMicroelectronics/stm32f1xx-hal-driver/tree/master)
- **[STMicroelectronics STM32 boards - QEMU Documentation](https://www.qemu.org/docs/master/system/arm/stm32.html)**

### Debuggers
- [Demystifying Debuggers, Part 1: A Busy Intersection - Ryan Fleury](https://www.rfleury.com/p/demystifying-debuggers-part-1-a-busy)
- [How debuggers work: Part 1: Basics - Eli Bendersky](https://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1)
